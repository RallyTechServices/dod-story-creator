<!DOCTYPE html>
<html>
<head>
    <title>Feature Definition of Done Story Creator</title>
    <!--  (c) 2014 Rally Software Development Corp.  All Rights Reserved. -->
    <!--  Build Date: Mon Mar 09 2015 15:21:34 GMT-0700 (PDT) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Mon Mar 09 2015 15:21:34 GMT-0700 (PDT)";
        var CHECKSUM = 31227084882;
    </script>
    
    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
             
/**
 * A link that pops up a version dialog box
 */

Ext.define('Rally.technicalservices.InfoLink',{
    extend: 'Ext.Component',
    alias: 'widget.tsinfolink',
    
    /**
     * @cfg {String} informationHtml
     * Additional text to be displayed on the popup dialog (for exmaple,
     * to add a description of the app's use or functionality)
     */
    informationHtml: null,
    
    /**
     * 
     * cfg {String} title
     * The title for the dialog box
     */
     title: "Build Information",
    
    renderTpl: "<div id='{id}-infolinkWrap' class='tsinfolink'>i</div>",

    initComponent: function() {
        this.callParent(arguments);
       
    },
    
    onRender: function() {
        this.callParent(arguments);
        this.mon(this.el,'click',this.onClick,this);
    },
    _generateChecksum: function(string){
        var chk = 0x12345678,
            i;
        string = string.replace(/var CHECKSUM = .*;/,"");
        string = string.replace(/\s/g,"");  //Remove all whitespace from the string.
        
        for (i = 0; i < string.length; i++) {
            chk += (string.charCodeAt(i) * i);
        }
    
        return chk;
    },
    _checkChecksum: function(container) {
        var me = this;
        Ext.Ajax.request({
            url: document.URL,
            params: {
                id: 1
            },
            success: function (response) {
                text = response.responseText;
                if ( CHECKSUM ) {
                    if ( CHECKSUM !== me._generateChecksum(text) ) {
                        console.log("Checksums don't match!");
                        if ( me.dialog ) {
                            me.dialog.add({xtype:'container',html:'Checksums do not match'});
                        }
                    }
                }
            }
        });
    },
    onClick: function(e) {
        var me = this;
        this._checkChecksum(this);
        
        var dialog_items = [];
        
        if ( this.informationHtml ) {
            dialog_items.push({
                xtype:'container',
                html: this.informationHtml
            });
        }
                
        dialog_items.push({
            xtype:'container',
            html:"This app was created by the Rally Technical Services Team."
        });
        
        if ( APP_BUILD_DATE ) {
            dialog_items.push({
                xtype:'container',
                html:'Build date/time: ' + APP_BUILD_DATE
            });
        }
        
        if (this.dialog){this.dialog.destroy();}
        this.dialog = Ext.create('Rally.ui.dialog.Dialog',{
            defaults: { padding: 5, margin: 5 },
            closable: true,
            draggable: true,
            title: me.title,
            items: dialog_items
        });
        this.dialog.show();
    }
});

/*
 */
Ext.define('Rally.technicalservices.Logger',{
    constructor: function(config){
        Ext.apply(this,config);
    },
    log: function(args){
        var timestamp = "[ " + Ext.util.Format.date(new Date(), "Y-m-d H:i:s.u") + " ]";
        //var output_args = arguments;
        //output_args.unshift( [ "[ " + timestamp + " ]" ] );
        //output_args = Ext.Array.push(output_args,arguments);
        
        var output_args = [];
        output_args = Ext.Array.push(output_args,[timestamp]);
        output_args = Ext.Array.push(output_args, Ext.Array.slice(arguments,0));

        window.console && console.log.apply(console,output_args);
    }

});

Ext.define('Rally.technicalservices.data.Chunker',{
    MAX_CHUNK_SIZE: 25,
    logger: new Rally.technicalservices.Logger(),
    config: {
        fetch: null,
        find: null,
        chunkField: null,
        chunkOids: null
    },
    constructor: function(config){
        this.initConfig(config);
    },
    load: function(){
        var deferred = Ext.create('Deft.Deferred');
        var oids = this.chunkOids; 
        var promises = [];
        
        if (oids.length > this.MAX_CHUNK_SIZE){
            var start_idx = 0;
            console.log('original array',oids);
            while(start_idx < oids.length){
                chunk_values = oids.splice(start_idx, this.MAX_CHUNK_SIZE);
                promises.push(this._fetchRecords(chunk_values));
            }
        } else {
            promises.push(this._fetchRecords(oids));
        }
    
        if (promises.length == 0){
            deferred.resolve();
        }
        Deft.Promise.all(promises).then({
            scope: this,
            success: function(records) {
                var data = _.flatten(records);
                deferred.resolve(data);
           },
           failure: function(){
               deferred.resolve([]);
           }
        });
        return deferred; 
    },
    _fetchRecords: function(object_ids){
        var deferred = Ext.create('Deft.Deferred');
        
        var find = this.find;
        find[this.chunkField] = {$in: object_ids}
        
        Ext.create('Rally.data.lookback.SnapshotStore',{
            fetch: this.fetch,
            autoLoad: true,
            find: find, 
            listeners: {
                scope: this,
                load: function(store, records, success){
                    this.logger.log('chunking success', success);
                    deferred.resolve(records);
                }
            }
        });
        return deferred;  
    }
});
Ext.define('Rally.technicalservices.data.DoDModel',{
    extend: 'Ext.data.Model',
    fields: [
             {name: 'FeatureFormattedID', type: 'string'},
             {name: 'FeatureName', type:'string'}
             ],
    constructor: function(config){
        this.initConfig(config);
        console.log(this.fields);
        var fields = [];
        if (config.additionalFields){
            fields =  _.difference(this.fields, config.additionalFields);
        }
       // this.fields.push(config.additionalFields);
        console.log(fields );
    }
});
Ext.define('Rally.technicalservices.FileUtilities', {
    singleton: true,
    logger: new Rally.technicalservices.Logger(),
    
    saveTextAsFile: function(textToWrite, fileName)
    {
        var textFileAsBlob = new Blob([textToWrite], {type:'text/plain'});
        var fileNameToSaveAs = fileName;

        var downloadLink = document.createElement("a");
        downloadLink.download = fileNameToSaveAs;
        downloadLink.innerHTML = "Download File";
        if (window.webkitURL != null)
        {
            // Chrome allows the link to be clicked
            // without actually adding it to the DOM.
            downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
        }
        else
        {
            // Firefox requires the link to be added to the DOM
            // before it can be clicked.
            downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
            downloadLink.onclick = destroyClickedElement;
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
        }
        downloadLink.click();
    },
    destroyClickedElement: function(event)
    {
        document.body.removeChild(event.target);
    },
    convertDataArrayToCSVText: function(data_array, requestedFieldHash){
       
        var text = '';
        Ext.each(Object.keys(requestedFieldHash), function(key){
            text += requestedFieldHash[key] + ',';
        });
        text = text.replace(/,$/,'\n');
        
        Ext.each(data_array, function(d){
            Ext.each(Object.keys(requestedFieldHash), function(key){
                if (d[key]){
                    if (typeof d[key] === 'object'){
                        if (d[key].FormattedID) {
                            text += Ext.String.format("\"{0}\",",d[key].FormattedID ); 
                        } else if (d[key].Name) {
                            text += Ext.String.format("\"{0}\",",d[key].Name );                    
                        } else if (!isNaN(Date.parse(d[key]))){
                            text += Ext.String.format("\"{0}\",",Rally.util.DateTime.formatWithDefaultDateTime(d[key]));
                        }else {
                            text += Ext.String.format("\"{0}\",",d[key].toString());
                        }
                    } else {
                        text += Ext.String.format("\"{0}\",",d[key] );                    
                    }
                } else {
                    text += ',';
                }
            },this);
            text = text.replace(/,$/,'\n');
        },this);
        return text;
    }
});
Ext.override(Ext.layout.container.Editor, {
    calculate: function(ownerContext) {
        console.log(ownerContext);
        var me = this,
            owner = me.owner,
            autoSize = owner.autoSize,
            fieldWidth,
            fieldHeight;
            
        if (autoSize === true) {
            autoSize = me.autoSizeDefault;
        }

        
        if (autoSize) {
            fieldWidth  = me.getDimension(owner, autoSize.width,  'getWidth',  owner.width);
            fieldHeight = me.getDimension(owner, autoSize.height, 'getHeight', owner.height);
        }

        if (ownerContext.childItems[0]){
            ownerContext.childItems[0].setSize(fieldWidth, fieldHeight);
        }

        
        ownerContext.setWidth(fieldWidth);
        ownerContext.setHeight(fieldHeight);

        
        ownerContext.setContentSize(fieldWidth || owner.field.getWidth(),
                                    fieldHeight || owner.field.getHeight());
    }
});


Ext.define('Rally.technicalservices.dialog.TemplateCopier', {
    extend: 'Rally.ui.dialog.Dialog',
    logger: new Rally.technicalservices.Logger(),
    autoShow: true,
    draggable: true,
    width: 300,
    modal: true,
    config: {
        title: 'Create Stories',
        /**
         * createRequests - an array of objects that contain the following keys:
         *      - Parent (Feature) FormattedID 
         *      - Parent (Feature) ObjectID
         *      - Story Type
         *      - Overridden fields (Code Deployment Type, Release, Modified Name) 
         */
        copyRequests: null,
// Update Name
// Set codeDeployment
// Set release to feature's release,
// Update PortfolioItem (parent)

        templateArtifactHash: null,  //{}
        templateArtifactKeyField: 'c_StoryType',
        templateModel: 'HierarchicalRequirement',
        templateCopyFields: ['c_DoDStoryType','Project','Name','Description','Release'],
        templateFilters: [{
            property: 'PortfolioItem',
            value: 'portfolioitem/feature/24797386560'
        }],
    },

    constructor: function(config) {
        Ext.apply(this,config);
        this.callParent(arguments);
    },
    initComponent: function() {
        this.callParent(arguments);
        this.addEvents('artifactscreated');
        this._buildPreview();  
        this._buildButtons();
    },    
    _buildPreview: function(){
        this.logger.log('_buildPreview', this.copyRequests);
        var ct = this.add({
            xtype: 'container',
            layout: {
                align: 'center'
            },
            tpl: '<b>Stories to Create:</b><br/><br/><tpl for=".">{c_DoDStoryType} for {FormattedID}<br/></tpl>'
        });
        ct.update(this.copyRequests);
    },

    _create: function(){
        this.logger.log('_create');
        
        this._fetchTemplates(this.templateModel, this.templateCopyFields, this.templateFilters).then({
            scope: this,
            success: function(totalTemplates){
                this._copyTemplates(totalTemplates).then({
                    scope: this,
                    success: function(requests){
                        this.fireEvent('artifactscreated',requests);
                        this.destroy();
                    }
                });
            }
        });
    },
    _copyTemplates: function(totalTemplates){
        var deferred = Ext.create('Deft.Deferred');
        
        this.logger.log('_copyTemplates', totalTemplates, this.copyRequests, this.templateArtifactHash);
        if (totalTemplates == 0){
            //Alert the user that they might need permissions to the main project.
            deferred.resolve();
            return;
        }
        
        var model = this._createModel(this.templateModel).then({
            scope: this,
            success: function(model){
                this.logger.log('modelCreated')
                this.model = model;  
                var promises = []; 
                
                Ext.each(this.copyRequests, function(cr){
                    var story_type = cr[this.templateArtifactKeyField];

                    var artifact_to_copy = this.templateArtifactHash[story_type];

                    this.logger.log('_copyTemplates', story_type, artifact_to_copy, this.templateArtifactHash, this.templateArtifactHash[story_type],'x');
                    if (artifact_to_copy){
                        var fields = this._getNewArtifactFields(artifact_to_copy, cr.overrideFields);
                        this.logger.log('_copyTemplates', fields, artifact_to_copy);
                        var fn = function(){
                            var deferred = Ext.create('Deft.Deferred');
                            this._createArtifact(this.model,fields,cr).then({
                                scope: this,
                                success: function(copyRequest){
                                    deferred.resolve(copyRequest);
                                }
                            });
                            return deferred;  
                        }
                        promises.push(fn);
                    } else {
                        //todo alert user that there is a problem
                    }
                },this);
                
                this.logger.log('promises', promises.length);
                if (promises.length > 0){
                    Deft.Chain.sequence(promises, this).then({
                        scope: this,
                        success: function(requests){
                            this.logger.log('_copyTemplates createArtifacts Success', requests);
                            deferred.resolve(requests);
                        },
                        failure: function(){
                            this.logger.log('_copyTemplates, createArtifact failure');
                        }
                    });
                }
            }
        });  
        return deferred; 
    },

    _getNewArtifactFields: function(artifactToCopy, overrideFields) {
        this.logger.log('_getNewArtifactFields', artifactToCopy, overrideFields);
            
        var new_fields = {};
        Ext.each(this.templateCopyFields, function(f){
            new_fields[f] = artifactToCopy.get(f);
        });
        
        if (overrideFields){
            Ext.Object.each(overrideFields, function(key,value){
                if (value){
                    new_fields[key] = value;                      
                }
            });            
        }
        
        new_fields['Name'] = artifactToCopy.get('Name').replace('US Template',new_fields['Name']);
        return new_fields;  
      },
      
     _createModel: function(modelType){
         var deferred = Ext.create('Deft.Deferred');
         Rally.data.ModelFactory.getModel({
             type: modelType,
             success: function(model) {
                deferred.resolve(model);
             }
         });
         return deferred; 
     },
     _createArtifact: function(model, fields, copyRequest) {
         var deferred = Ext.create('Deft.Deferred');
         this.logger.log('_createArtifact start');
         var record = Ext.create(model, fields);
         record.save().then({
             scope: this,
             success: function(result){
                 this.logger.log('_createArtifact successful', result);
                 Rally.ui.notify.Notifier.showCreate({artifact: result});                
                 copyRequest.resultArtifact = result;
                 deferred.resolve(copyRequest);
             },
             failure: function(operation){
                 this.logger.log('_createArtifact failed');
                 copyRequest.resultArtifact = operation.error.errors[0];
                 deferred.resolve(copyRequest);
             }
         });
         return deferred.promise;
     },
     _fetchTemplates: function(model, fetch, filters){
         var deferred = Ext.create('Deft.Deferred');
         this.logger.log('_fetchTemplates',model,fetch,filters);
         Ext.create('Rally.data.wsapi.Store',{
             model: model,
             fetch: fetch,
             filters: filters, 
             autoLoad: true,
             context: {project: null},
             limit: 'Infinity',
             listeners: {
                 scope: this,
                 load: function(store, records, success){
                     this.logger.log('_fetchTemplates load success', records.length, records);
                     this.templateArtifactHash = {};
                     Ext.each(records, function(r){
                         var key = r.get(this.templateArtifactKeyField);
                         this.templateArtifactHash[key] = r;
                     }, this);
                     deferred.resolve(records.length);
                 }
             }
         });
         return deferred; 
     },

    _buildButtons: function(){
        this.addDocked({
            xtype: 'toolbar',
            dock: 'bottom',
            padding: '8px 0 0',
            layout: {
                type: 'hbox',
                pack: 'center'
            },
            ui: 'footer',
            items: [{
                xtype: 'rallybutton',
                itemId: 'btnCreate',
                text: 'Create',
                cls: 'primary small',
                scope: this,
                handler: this._create
            },{
                xtype: 'rallybutton',
                itemId: 'cancelButton',
                text: 'Not Now',
                cls: 'secondary small',
                ui: 'link',
                scope: this,
                handler: this.destroy
            }]
        });
    }
});
Ext.define('CustomApp', {
    extend: 'Rally.app.App',
    componentCls: 'app',
    logger: new Rally.technicalservices.Logger(),
    items: [
        {xtype:'container',
            itemId:'header', 
            layout: {type:'hbox'}, 
            padding: 5},
        {xtype:'container',itemId:'display_box', padding: 5, layout: {type: 'fit'}},
        {xtype:'container',itemId:'footer', padding: 5, layout: {type: 'hbox'}}, 
        {xtype:'tsinfolink'}
    ],
    config: {
        releaseField: 'c_CodeDeploymentSchedule',
        releaseFieldLabel: 'Deployment Schedule',
        storyTypeField: 'c_DoDStoryType',
        portfolioItemL1: 'PortfolioItem/Feature',
        dodStatusPrefix: 'c_DoDStatus',
        dodStatusDisplayPrefix: 'DoD Status: ',
        requiredValue: 'Required'
    },
    exportFieldMapping: {
        'FormattedID': 'FormattedID',
        'Name': 'Name'
    },
    dodFeatureFields: null,
    featureRecords: null, 
    //UI configurations
    buttonWidth: 75, 
    buttonMargin: 10,
    noEntryText: '--',
    
    launch: function() {
        this._fetchDoDFields().then({
            scope: this,
            success: function(fields){
                this.dodFeatureFields = fields; 
                this._initialize();
            }
        });
    },

    _getExportButton: function(){
        return this.down('#btn-export');
    },
    _getUpdateButton: function(){
        return this.down('#btn-update');
    },
    _getHeaderContainer: function(){
        return this.down('#header');
    },
    _getFooterContainer: function(){
        return this.down('#footer');
    },
    _getBodyContainer: function(){
        return this.down('#display_box');
    },
    _initialize: function(){
        this._getHeaderContainer().add({
                xtype: 'rallyfieldvaluecombobox',
                model: 'UserStory',
                itemId: 'cb-release',
                field: this.releaseField,
                fieldLabel: this.releaseFieldLabel,
                labelWidth: 150,
                margin: 10,
                labelAlign: 'right',
                listeners: {
                    scope: this,
                    change: this._buildGrid,
                }
        });
        this._getHeaderContainer().add({
            xtype: 'component',
            flex: 1
        });
        this._getHeaderContainer().add({
                xtype: 'rallybutton',
                text: 'Export',
                itemId: 'btn-export',
                margin: 10,
                scope: this,
                width: this.buttonWidth,
                handler: this._export
        });
        
       
       this._getFooterContainer().add({
           xtype: 'component',
           flex: 1
       });
       this._getFooterContainer().add({
            xtype: 'rallybutton',
            text: 'Update',
            itemId: 'btn-update',
            width: this.buttonWidth,
            margin: 10,
            scope: this, 
            handler: this._update
        });
        
        this._getHeaderContainer().add();
    },
    _export: function(){
        this.logger.log('_export');
        var grid = this.down('#rally-grid');
        if (this.exportData && this.exportData.length > 0){
            var code_deployment = this.down('#cb-release').getValue() || 'none';  
            var filename = Ext.String.format('dod-status-{0}.csv',code_deployment);
            var text = Rally.technicalservices.FileUtilities.convertDataArrayToCSVText(this.exportData, this.exportFieldMapping);
            Rally.technicalservices.FileUtilities.saveTextAsFile(text, filename);
        } else {
            Rally.ui.notify.Notifier.showWarning({message: 'No data to export'});
        }
    },  
    _update: function(){
        this.logger.log('_update');
        
        var grid = this._getGrid();
        if (grid == null){
            Rally.ui.notify.Notifier.showWarning({message: 'No records to update'});
            return;  
        }
        
        var store = grid.getStore(); 

        this.logger.log('_update', store);
        var features_to_update = [];
        var dod_re = new RegExp(this.dodStatusPrefix);

        for (var i=0; i<store.totalCount; i++){
            
            var r = store.getAt(i);
            var obj = r.getData();
            var raw_obj = r.raw;
            
            var keys = _.keys(obj);
            var stories_to_add = [];
            var update_feature = {
                    newStories: [], 
                    updatedFields: {}, 
                    _ref: obj._ref, 
                    FormattedID: obj.FormattedID, 
                    ObjectID: obj.ObjectID,
                    updateFlag: false};

            Ext.each(keys, function(key){
                if (dod_re.test(key)){
                    if (obj[key] === 'Required'){
                        update_feature.newStories.push(key); 
                    }
                    if (raw_obj[key] != obj[key]){
                        update_feature.updatedFields[key] = obj[key]; 
                    }
                }
            });
            if (update_feature.newStories.length > 0 || !_.isEmpty(update_feature.updatedFields)){
                features_to_update.push(update_feature);
            }
        }

        this.logger.log('_update',features_to_update);

        this._updateFeatures(features_to_update).then({
            scope: this,
            success: function(){
                this._createStories(features_to_update);                
            }
        
        });
    },
    _createStories: function(featuresToUpdate){
        //Create Stories 
        var code_deployment_val = this.down('#cb-release').getValue();
        var grid_store = this._getGrid().getStore();  
        
        var copy_requests = [];
        Ext.each(featuresToUpdate, function(f){
            if (f.newStories.length > 0){
                Ext.each(f.newStories, function(ns){
                    var cr = {};
                    cr[this.storyTypeField] = this._getStoryKey(ns);  
                    cr['FormattedID'] = f.FormattedID;
                    cr['overrideFields'] ={};
                    cr.overrideFields['PortfolioItem'] = f._ref;
                    cr.overrideFields[this.releaseField] = code_deployment_val;
                    cr.overrideFields['Name'] = f.FormattedID;
                    cr.overrideFields['Release'] = f.Release;
                    copy_requests.push(cr);
                },this);
            }
        },this);
        
        this.logger.log('_createStories', copy_requests);
        
        if (copy_requests.length > 0){
            var dlg_stories = Ext.create('Rally.technicalservices.dialog.TemplateCopier',{
                copyRequests: copy_requests,
                templateArtifactKeyField: this.storyTypeField,
                title: "Create Stories",
                listeners: {
                    scope: this,
                    artifactscreated: function(requests){
                        this.logger.log('artifacts Created',requests);
                        this._updateGrid(requests);
                    }
                }
            });
            dlg_stories.show();
        }
    },
    _getStoryTypeFieldNameFromDisplayName: function(displayName){
        this.logger.log('_getStoryTypeFieldNameFromDisplayName',displayName);
        var fieldName = null; 
        Ext.Object.each(this.exportFieldMapping, function(key, val){
            if (val === displayName){
                fieldName = key;
                return false;
            }
        });
        return fieldName; 
    },
    _updateGrid: function(requests){
        this.logger.log('_updateGrid', requests);
        
        var store = this._getGrid().getStore();
        var feature_hash = {};
        for (var i=0; i<store.getTotalCount(); i++){
            var rec = store.getAt(i);
            feature_hash[rec.get('FormattedID')] = rec;
        }
        
        Ext.each(requests, function(r){
            rec = feature_hash[r.FormattedID];
            console.log(r.FormattedID, r.resultArtifact);
            if (typeof r.resultArtifact == 'object'){
                var field = this._getStoryTypeFieldNameFromDisplayName(r[this.storyTypeField]);
                rec.set(field, {FormattedID: r.resultArtifact.get('FormattedID'), ObjectID: r.resultArtifact.get('ObjectID')});
            } else {
                var msg = Ext.String.format('Unable to create {0} artifact for {1}',r[this.storyTypeField],r.FormattedID);
                Rally.ui.notify.Notifier.showError({message: msg});
            }
        }, this);
       // this._createGrid(store);

    },
    _getStoryKey: function(fieldName){
        var displayName = fieldName;
        Ext.each(this.dodFeatureFields, function(field){
            if (field.name == fieldName){
                displayName = field.displayName;
                return false; 
            }
        });
        return this._getStoryTypeFromDisplayName(displayName); //.replace(this.dodStatusDisplayPrefix,''); 
    },
    _updateFeatures: function(featureObjs){
        var deferred = Ext.create('Deft.Deferred');
        Rally.data.ModelFactory.getModel({
            type: this.portfolioItemL1,
            scope: this,
            success: function(model) {
                this.logger.log('_updateFeatures model loaded');
                var promises = []; 
                Ext.each(featureObjs, function(obj){
                    if (!_.isEmpty(obj.updatedFields)){
                        promises.push(function(){this._updateFeature(model, obj)});
                    }
                }, this);
                
                if (promises.length == 0){
                    deferred.resolve();
                } else {
                    Deft.Chain.sequence(promises, this).then({
                        scope: this,
                        success: function(){
                            this.logger.log('_updateFeatures promises completed');
                            deferred.resolve();
                        }
                    });
                }
            }
        });
        return deferred;  
    },
    _updateFeature: function(model, feature){
        var deferred = Ext.create('Deft.Deferred');
        var fetch = _.keys(feature.updatedFields);
        var formatted_id = feature.FormattedID;
        this.logger.log('_updateFeature', feature);
        model.load(feature.ObjectID, {
            fetch: fetch,
            scope: this,
            callback: function(result, operation) {
                this.logger.log('_updateFeature loaded', operation);
                if(operation.wasSuccessful()) {
                    this.logger.log('_updateFeature load success');
                    Ext.Object.each(feature.updatedFields, function(field,value){
                        this.logger.log('setting',feature.FormattedID, field,value);
                        result.set(field,value);
                    }, this);
                    result.save().then({
                        scope: this,
                        success: function(f){
                            Rally.ui.notify.Notifier.showUpdate({artifact: f});
                            this.logger.log('_updateFeature save success', f);
                            deferred.resolve();
                        }
                    });
                } else {
                    this.logger.log('_updateFeature unsuccessful');
                    var msg = Ext.String.format("{0} update failed [Error:  {1}]",formatted_id, operation.getError());
                    Rally.ui.notify.Notifier.showError({message: msg});
                    deferred.resolve();
                }
            }
        });
        return deferred;  
    },
    _getStoryTypeFromDisplayName: function(displayName){
        return displayName.replace(this.dodStatusDisplayPrefix,'',"i");
    },
    _fetchDoDFields: function(){
        var deferred = Ext.create('Deft.Deferred');
        var dod_fields = [];  
        Rally.data.ModelFactory.getModel({
            type: this.portfolioItemL1,
            scope: this,
            success: function(model) {
                var fields = model.getFields();
                var re = new RegExp("^" + this.dodStatusPrefix ,"i");
                Ext.each(fields, function(f){
                    if (re.test(f.name)){
                        this.exportFieldMapping[f.name] = this._getStoryTypeFromDisplayName(f.displayName);
                        dod_fields.push(f);
                    }
                },this);
                deferred.resolve(dod_fields);
            }
        });
        
        return deferred;  
    },
    _renderDodColumn: function(v,m,r){
            var data;

            var editableValues = ['Required','Exemption Requested'];

            if (typeof v == "object") {
                var link_text= Ext.String.format('{0}: {1}', v.FormattedID, v.Name); 
                return Rally.nav.DetailLink.getLink({record: '/hierarchicalrequirement/'+ v.ObjectID, text: link_text});
            } else {
                if (Ext.Array.contains(editableValues, v) || v == null ){
                    // add a css selector to the td html class attribute we can use it after grid is ready to render the slider
                    m.tdCls = m.tdCls + 'editable-status';
                }
            } 
            return v; 
    },
    _getColumnCfgs: function(){
        var noEntryText = this.noEntryText; 
        var columns = 
            [{text:'Feature',
             dataIndex:'FormattedID',
             flex: 1,
             renderer: function(v,m,r){
                 var link_text= Ext.String.format('{0}: {1}', v, r.get('Name')); 
                 return Rally.nav.DetailLink.getLink({record: r.get('_ref'), text: link_text});
             }
          }];
        
        var editor_store = Ext.create('Ext.data.Store', {
            fields: ['name'],
            data : [
                {"name":"Required"},
                {"name":"Exemption Requested"},
                {"name": "Exemption Approved"}
                //...
            ]
        });
        
        Ext.each(this.dodFeatureFields, function(f){
            var col = {
                  //xtype: 'container',
                  text: this._getStoryTypeFromDisplayName(f.displayName),  //.replace(this.dodStatusDisplayPrefix,'',"i"),
                  dataIndex: f.name,
                  renderer: function(v,m,r){
                      if (typeof v == "object"){
                          var link_text= Ext.String.format('{0}', v.FormattedID); 
                          return Rally.nav.DetailLink.getLink({record: '/hierarchicalrequirement/'+ v.ObjectID, text: link_text});
                      }
                      if (v && v.length > 0){
                          return v;
                      } 
                      return noEntryText;
                  },
                  editor: {
                      xtype: 'combobox',
                      store: editor_store,
                      displayField: "name",
                      valueField: "name",
                      allowBlank: true,
                      emptyText: noEntryText
                  }

            };
            columns.push(col);
        },this);
        return columns;
    },
    _createGrid: function(store){
        if (this.down('#rally-grid')){
            this.down('#rally-grid').destroy();
        } 
        var uneditableValues = ['Exemption Approved'];
        var columns = this._getColumnCfgs();
        this._getBodyContainer().add({
            xtype: 'rallygrid',
            itemId: 'rally-grid',
            margin: 10,
            store: store, 
            showRowActionsColumn: false,
            scope: this,
            columnCfgs: columns,
            selType: 'cellmodel',
            listeners: {
                beforeedit: function(editor, e){
                    if (typeof e.value == "object") {
                        e.cancel = true; 
                        return false; 
                    }
                }
            },
            plugins: [
                Ext.create('Ext.grid.plugin.CellEditing', {
                    clicksToEdit: 1
                    
                })
            ],
        });
        
    },
    _getGrid: function(){
        return this.down('#rally-grid')
    },
    _clearGrid: function(){
        if (this._getGrid()){
            this._getGrid().destroy();            
        }
    },
    _buildGrid: function(cb){
        this.logger.log('_buildGrid');
        if (cb.getValue() == null){
            return;
        }
        this._clearGrid();
        
        this.setLoading(true);
        
        this._fetchFeatures(this.releaseField, cb.getValue()).then({
            scope: this,
            success: function(store){
                this._createGrid(store);
                this.setLoading(false);
            }
        
        });
    },

    _fetchFeatures: function(releaseField, releaseValue){
        var deferred = Ext.create('Deft.Deferred');
        var dod_fields = [];
        Ext.each(this.dodFeatureFields, function(f){
            dod_fields.push(f.name)
        });
        var fetch_fields = _.union(['FormattedID','Name','_ref','Release'], dod_fields); 
        this.logger.log('_fetchFeatures',fetch_fields, releaseField,releaseValue);
        Ext.create('Rally.data.wsapi.Store',{
            fetch: fetch_fields,
            model: this.portfolioItemL1,
            autoLoad: true,
            filters: [{
                property: releaseField,
                value: releaseValue
            }],
            listeners: {
                scope: this,
                load: function(store, records, success){
                    this.logger.log('_fetchFeatures load', records.length, success);
                    var feature_oids = _.map(records, function(r){return r.get('ObjectID')});
                    this.featureRecords = records; 
                    this._fetchChildStories(feature_oids, releaseValue).then({
                        scope: this,
                        success: function(story_records){
                            this.logger.log('_fetchChildStories', feature_oids, story_records);
                            var store = this._buildCustomStore(records, story_records)
                            deferred.resolve(store);
                        }
                    });
                }
            }
        });
        return deferred;  
    },
    _fetchChildStories: function(feature_oids, releaseValue){
        var deferred = Ext.create('Deft.Deferred');
        
        var find = {
                "_TypeHierarchy": 'HierarchicalRequirement',
                "__At": "current"
            };
        find[this.storyTypeField] = {$ne: null};
        if (releaseValue){
            find[this.releaseField] = releaseValue;
        } else {
            find[this.releaseField] = null;
        }
      //  find[this.releaseField] = releaseValue;  
        this.logger.log('_fetchChildStories releaseValue',releaseValue, releaseValue == null);
        var chunker = Ext.create('Rally.technicalservices.data.Chunker',{
            fetch: ['FormattedID',this.storyTypeField, this.releaseField, 'PortfolioItem','ObjectID','Name'],
            find: find,
            chunkField: "PortfolioItem",
            chunkOids: feature_oids
        });
        chunker.load().then({
            scope: this,
            success: function(story_records){
                this.logger.log('_fetchChildStories', story_records.length, story_records);
                deferred.resolve(story_records);
            }
        });
        return deferred;
    },
    _buildCustomStore: function(features, stories){
         var feature_hash = {};
        Ext.each(stories, function(s){
            var pi = s.get('PortfolioItem');
            feature_hash[pi] = feature_hash[pi] || [];
            feature_hash[pi].push(s.getData());
        });
        
       this.logger.log('_buildCustomStore feature_hash', feature_hash);
        var data = []; 
        
        Ext.each(features, function(f){
            var rec = {'FormattedID':f.get('FormattedID'),
                    'Name': f.get('Name'), 
                    '_ref': f.get('_ref'), 
                    'ObjectID': f.get('ObjectID'),
                    'Release': f.get('Release') || ''
            };
            Ext.each(this.dodFeatureFields, function(dod_f){
                var dod_type = this._getStoryTypeFromDisplayName(dod_f.displayName); //.replace(this.dodStatusDisplayPrefix,'');
                var story = null;  
                Ext.each(feature_hash[f.get('ObjectID')], function(s){
                    this.logger.log('_buildCustomStore associated stories',s[this.storyTypeField],dod_type,dod_f.displayName);
                    if (s[this.storyTypeField] == dod_type){
                        story = s;
                        return false;
                    }
                }, this);
   
                if (story){
                    rec[dod_f.name] = story;
                } else  {
                    rec[dod_f.name] = f.get(dod_f.name);
                } 
            },this);
            this.logger.log('feature data',rec);
            data.push(rec);
        }, this);
        this.exportData = data;  
    
        return Ext.create('Rally.data.custom.Store',{
            autoSync: true,
            data: data
        });
    }
});
            
               Rally.launchApp('CustomApp', {
                   name: 'Feature Definition of Done Story Creator'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}
.approved: {
	color: 'red';
	background-color: 'green'
	
}

.rightbutton {
	align: 'right';
}
    </style>

</head>
<body></body>
</html>